pipeline {
    agent any

    stages {

        stage('Get Code') {
            steps {
                echo '📥 Clonando código desde la rama develop...'
                checkout([$class: 'GitSCM',
                    branches: [[name: '*/develop']],
                    userRemoteConfigs: [[url: 'https://github.com/andresh2004/todo-list-aws-mi-version']]
                ])
            }
        }

        stage('Static Test') {
            steps {
                echo '🔍 Ejecutando análisis estático con Flake8 y Bandit...'
                sh '''
                    pip install flake8 flake8-html bandit

                    mkdir -p reports/flake8
                    flake8 src --format=html --htmldir=reports/flake8 || true

                    mkdir -p reports/bandit
                    bandit -r src -f html -o reports/bandit/report.html || true
                '''
            }

            post {
                always {
                    echo '📤 Publicando reportes de análisis estático...'
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports/flake8',
                        reportFiles: 'index.html',
                        reportName: 'Flake8 Report'
                    ])
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports/bandit',
                        reportFiles: 'report.html',
                        reportName: 'Bandit Report'
                    ])
                }
            }
        }

        stage('Deploy') {
            steps {
                echo "🚀 Desplegando con SAM en entorno de Staging..."
                sh '''
                    sam build --template-file template.yaml

                    sam deploy \
                        --stack-name staging-todolist-aws \
                        --s3-bucket aws-sam-cli-managed-default-samclisourcebucket-7xmahjfstf4l \
                        --capabilities CAPABILITY_IAM \
                        --region us-east-1 \
                        --no-confirm-changeset \
                        --no-fail-on-empty-changeset
                '''
            }
        }
    }
}

