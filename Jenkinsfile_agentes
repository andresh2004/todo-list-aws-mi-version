pipeline {
    agent any

    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
    }

    stages {
        stage('Get Code') {
            steps {
                echo "Clonando el repositorio y cambiando a rama develop"
                checkout([$class: 'GitSCM',
                    branches: [[name: '*/develop']],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [],
                    userRemoteConfigs: [[url: 'git@github.com:andresh2004/todo-list-aws-mi-version.git']]
                ])
            }
        }

        stage('Install Dependencies') {
            steps {
                echo "Instalando dependencias necesarias para análisis y pruebas"
                sh '''
                    pip install bandit flake8 flake8-html pytest requests awscli
                '''
            }
        }

        stage('Static Test') {
            steps {
                echo "Ejecutando análisis estático con Bandit y Flake8"
                sh '''
                    mkdir -p reports
                    bandit -r src/ -f html -o reports/bandit_report.html || true
                    flake8 src/ --format=html --htmldir=reports/flake8-html || true
                '''
                publishHTML(target: [
                    reportName : 'Bandit Report',
                    reportDir  : 'reports',
                    reportFiles: 'bandit_report.html',
                    keepAll    : true,
                    alwaysLinkToLastBuild: true,
                    allowMissing: true
                ])
                publishHTML(target: [
                    reportName : 'Flake8 Violations',
                    reportDir  : 'reports/flake8-html',
                    reportFiles: 'index.html',
                    keepAll    : true,
                    alwaysLinkToLastBuild: true,
                    allowMissing: true
                ])
            }
        }

        stage('Deploy') {
            steps {
                echo "Desplegando aplicación con AWS SAM"
                sh '''
                    echo "Validando estructura del workspace"
                    ls -la
                    echo "Contenido de src"
                    ls -la src

                    sam build --template-file template.yaml
                    sam deploy \
                        --stack-name staging-todolist-aws \
                        --s3-bucket aws-sam-cli-managed-default-samclisourcebucket-7xmahjfstf4l \
                        --no-confirm-changeset \
                        --capabilities CAPABILITY_IAM \
                        --no-fail-on-empty-changeset
                '''
            }
        }

        stage('Rest Test') {
            steps {
                echo "Ejecutando pruebas de integración REST con pytest"
                sh '''
                    pip install pytest requests

                    echo "Obteniendo la URL base de la API desplegada..."
                    BASE_URL=$(aws cloudformation describe-stacks --stack-name staging-todolist-aws \
                        --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" --output text)

                    echo "URL pública detectada: $BASE_URL"

                    echo "Ejecutando pytest..."
                    BASE_URL=$BASE_URL PATH=$PATH:~/.local/bin pytest test/integration/todoApiTest.py --maxfail=1 --disable-warnings -q
                '''
            }
        }

        stage('Promote to Production') {
            steps {
                echo "Realizando merge de develop a master y promoviendo a producción"
                sh '''
                    git config user.name "jenkins"
                    git config user.email "andresh2004@gmail.com"
                    git checkout master
                    git merge origin/develop --no-edit
                    git push origin master

                    echo "Desplegando en Producción..."
                    echo "Verificando si el bucket S3 'todo-list-aws' existe..."
                    if ! aws s3api head-bucket --bucket todo-list-aws 2>/dev/null; then
                         echo " Bucket no encontrado, creando..."
                         aws s3 mb s3://todo-list-aws --region us-east-1
                       else
                         echo "El bucket S3 ya existe, continuando..."
                   fi

                     sam build --template-file template.yaml
                     sam deploy \
                        --stack-name production-todolist-aws \
                        --s3-bucket todo-list-aws \
                        --capabilities CAPABILITY_IAM \
                        --region us-east-1 \
                        --no-confirm-changeset \
                        --no-fail-on-empty-changeset
                '''
            }
        }
    }
}

