pipeline {
    agent any

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Get Code') {
            steps {
                echo '📥 Descargando el código fuente desde la rama develop...'
                sh 'git fetch origin develop && git checkout develop'
            }
        }

        stage('Static Test') {
            steps {
                echo '🔎 Ejecutando análisis estático con Flake8 y Bandit...'

                // Flake8 con salida HTML
                sh '''
                    pip install flake8 flake8-html bandit
                    flake8 src --format=html --htmldir=flake8_report || true
                    bandit -r src -f html -o bandit_report.html || true
                '''
            }
        }

        stage('Post Actions') {
            steps {
                echo '📤 Publicando reportes HTML...'
                publishHTML(target: [
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'flake8_report',
                    reportFiles: 'index.html',
                    reportName: 'Flake8 Report'
                ])
                publishHTML(target: [
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: '.',
                    reportFiles: 'bandit_report.html',
                    reportName: 'Bandit Report'
                ])
            }
        }

        stage('Deploy') {
            steps {
                echo '🚀 Desplegando aplicación Lambda en entorno de Staging...'
                sh '''
                    sam validate --template-file template.yaml

                    sam package \
                        --template-file template.yaml \
                        --s3-bucket aws-sam-cli-managed-default-samclisourcebucket-7xmahjfstf4l \
                        --s3-prefix staging-todolist-aws \
                        --output-template-file packaged.yaml

                    sam deploy \
                        --template-file packaged.yaml \
                        --stack-name staging-todolist-aws \
                        --capabilities CAPABILITY_IAM \
                        --no-confirm-changeset \
                        --no-fail-on-empty-changeset
                '''
            }
        }
    }
}

