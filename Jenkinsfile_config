pipeline {
    agent none

    stages {
        stage('Get Code') {
            agent { label 'agente-secundario' }
            steps {
                sh 'echo Ejecutando como: $(whoami) en $(hostname)'
                checkout scm

                script {
                    def configBranch = env.GIT_BRANCH?.contains('master') ? 'production' : 'staging'
                    echo "üîß Descargando configuraci√≥n desde rama: ${configBranch}"
                    sh """
                        rm -f samconfig.toml
                        git clone --branch ${configBranch} https://github.com/andresh2004/todo-list-aws-config.git config-repo
                        cp config-repo/samconfig.toml .
                        rm -rf config-repo
                        echo '‚úÖ samconfig.toml descargado correctamente:'
                        cat samconfig.toml
                    """
                }
            }
        }

        // Puedes copiar aqu√≠ las dem√°s etapas que ya tienes:
        // An√°lisis Est√°tico, Despliegue Serverless, Pruebas API REST, etc.
        // Solo aseg√∫rate de que usen el samconfig.toml descargado

        stage('Simulaci√≥n') {
            agent { label 'agente-secundario' }
            steps {
                sh 'echo Simulando despliegue con configuraci√≥n externa...'
            }
        }
    }
}

